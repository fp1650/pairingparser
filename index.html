<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VPS Pairing Parser (iPad Pro M4 Optimized)</title>
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="VPS Parser">
  <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
  <style>
    /* --- 1. Modern Variables & Dark Mode --- */
    :root {
      --bg-color: #ffffff;
      --text-color: #111827;
      --panel-bg: #f9fafb;
      --border-color: #e5e7eb;
      --muted-text: #6b7280;
      --primary-color: #2563eb;
      --primary-text: #ffffff;
      --hover-bg: #f3f4f6;
      --table-row-even-bg: #f9fafb;

      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);

      transition: background-color 0.3s ease, color 0.3s ease;
    }

    body.dark {
      --bg-color: #111827;
      --text-color: #f9fafb;
      --panel-bg: #1f2937;
      --border-color: #374151;
      --muted-text: #9ca3af;
      --hover-bg: #374151;
      --table-row-even-bg: #1a222e;
    }
    
    /* --- 2. CSS Grid Layout & Reset --- */
    html { 
      height: 100%; 
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    body { 
      background: var(--bg-color); 
      color: var(--text-color); 
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; 
      margin: 0; 
      font-size: 16px; 
      height: 100vh; 
      max-height: 100vh; 
      overflow: hidden; 
      
      /* --- âœ… CSS Grid Main Layout --- */
      display: grid;
      grid-template-rows: auto auto 1fr; /* Header, Controls, Table Area */
      gap: 12px;
      padding: 16px;
      box-sizing: border-box;
    }

    header {
      grid-row: 1;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-shrink: 0;
    }
    header h2 { margin: 0; }

    /* --- 3. Touch-Friendly Horizontal Scroll Controls --- */
    #top-controls {
      grid-row: 2;
      display: flex;
      gap: 16px;
      align-items: flex-end;
      padding: 16px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      background: var(--panel-bg);
      flex-shrink: 0;
      box-shadow: var(--shadow-sm);

      /* --- âœ… Touch-friendly Horizontal Scroll --- */
      overflow-x: auto;
      white-space: nowrap;
      -webkit-overflow-scrolling: touch; /* Inertial scroll on iOS */
    }

    .control-group {
      display: inline-flex; /* Use inline-flex to stay in one line */
      flex-wrap: nowrap;
      gap: 12px;
      align-items: flex-end;
    }
    .control-group.push-right { margin-left: auto; }

    /* --- 4. Full-Height Table Container --- */
    #table-container {
      grid-row: 3;
      display: flex;
      flex-direction: column;
      min-height: 0; /* CRITICAL for flex-grow to work */
      border: 1px solid var(--border-color);
      border-radius: 10px;
      overflow: hidden; /* Contains the table */
      background: var(--panel-bg);
      box-shadow: var(--shadow-sm);
    }
    
    #counts {
      flex-shrink: 0;
      padding: 8px 12px;
      font-size: 13px;
      color: var(--muted-text);
      border-bottom: 1px solid var(--border-color);
    }

    #table { 
      flex-grow: 1; /* âœ… Fills remaining vertical space */
      min-height: 0;
      /* Tabulator JS will set height: 100% */
    }

    /* --- 5. General Styling (Buttons, Inputs, etc.) --- */
    label { font-size: 13px; color: var(--muted-text); display: flex; flex-direction: column; gap: 4px; }
    input[type=text], input[type=time], input[type=file], select { 
      padding: 8px 10px; 
      border-radius: 6px; 
      border: 1px solid var(--border-color); 
      background: var(--bg-color); 
      color: var(--text-color); 
      font-size: 14px; 
      transition: border-color .2s, box-shadow .2s;
    }
    input[type=text]:focus, input[type=time]:focus, select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px var(--primary-color);
    }
    
    .btn { 
      padding: 8px 12px; 
      border-radius: 6px; 
      border: 1px solid var(--border-color); 
      background: var(--bg-color); 
      color: var(--text-color); 
      cursor: pointer; 
      font-size: 14px; 
      font-weight: 500;
      transition: background-color .2s, border-color .2s, box-shadow .2s;
    }
    .btn:hover { background: var(--hover-bg); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; background: var(--panel-bg); }
    .btn-primary, .btn-active { 
      background: var(--primary-color); 
      color: var(--primary-text); 
      border-color: var(--primary-color); 
    }
    .btn-primary:hover { background: #1d4ed8; border-color: #1d4ed8; }
    
    input[type=file]::file-selector-button { 
      background: var(--panel-bg); 
      color: var(--text-color); 
      border: 1px solid var(--border-color); 
      padding: 4px 8px; 
      border-radius: 4px; 
      margin-right: 8px; 
      cursor: pointer; 
      font-weight: 500;
    }
    #quickSearch { min-width: 200px; }

#uploadStatus { 
      font-size: 13px; 
      color: var(--muted-text); 
      margin-left: 12px; 
      display: none; /* <-- Add this line */
    }

    /* --- 6. Dropdown Menu Styling --- */
    .menu-wrap { position: relative; }
    .dropdown { 
      position: absolute; 
      top: 110%; 
      right: 0; 
      z-index: 150; 
      background: var(--panel-bg); 
      color: var(--text-color); 
      border: 1px solid var(--border-color); 
      border-radius: 10px; 
      box-shadow: var(--shadow-lg); 
      padding: 8px; 
      min-width: 240px; 
      display: none; 
      max-height: 50vh; 
      overflow-y: auto;
    }
    .dropdown.open { display: block; }
    .dropdown h4 { margin: 6px 8px 8px; font-size: 13px; color: var(--muted-text); font-weight: 600; }
    .dropdown .row { display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 4px; }
    .dropdown .row:hover { background: var(--hover-bg); }
    .dropdown .row input { transform: translateY(1px); }
    .hint { color: var(--muted-text); font-size: 12px; margin: 0 8px 8px; }

    /* --- 7. Tabulator Theme Tweaks --- */
    .tabulator { 
      background-color: var(--panel-bg) !important; 
      color: var(--text-color) !important; 
      border: none !important; 
    }
    .tabulator-header, .tabulator-col { 
      background-color: var(--panel-bg) !important; 
      color: var(--muted-text) !important; 
      border-bottom: 1px solid var(--border-color) !important; 
      border-right: 1px solid var(--border-color) !important;
    }
    .tabulator-row { 
      background-color: var(--panel-bg) !important; 
      color: var(--text-color) !important; 
      border-bottom: 1px solid var(--border-color) !important;
    }
    .tabulator-row.tabulator-row-even { 
      background-color: var(--table-row-even-bg) !important; 
    }
    .tabulator-cell { border-right: 1px solid var(--border-color) !important; }
    .tabulator-row:hover { background-color: var(--hover-bg) !important; }
    .tabulator .tabulator-footer { 
      background-color: var(--panel-bg) !important; 
      color: var(--text-color) !important; 
      border-top: 1px solid var(--border-color) !important; 
    }
    .tabulator .tabulator-col, .tabulator .tabulator-header .tabulator-col .tabulator-col-title { text-align: center; }
    .tabulator .tabulator-cell { text-align: center; }
    .cell-left { text-align: left !important; }

    /* --- 8. GPU-Accelerated Loader --- */
    #loader-container { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 4px; 
      background: transparent; 
      z-index: 9999; 
      display: none; 
    }
    #loader-bar { 
      width: 0; 
      height: 100%; 
      background: var(--primary-color); 
      transition: width .35s ease-out; 
      box-shadow: 0 2px 4px var(--primary-color);
      /* --- âœ… GPU-Accelerated Animation --- */
      transform: translateZ(0);
    }

    /* --- 9. Redesigned Full-Screen Modal --- */
    #modal { 
      position: fixed; 
      inset: 0; 
      background: rgba(0, 0, 0, 0.55); 
      display: none; 
      align-items: center; 
      justify-content: center; 
      z-index: 120;
      backdrop-filter: blur(4px);
    }
    #modal .panel { 
      background: var(--panel-bg); 
      color: var(--text-color); 
      padding: 16px 24px 24px; 
      border-radius: 12px; 
      max-width: 960px; 
      width: 94%; 
      max-height: 86vh; 
      box-shadow: var(--shadow-lg);
      /* Use flex for internal layout */
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }
    #modalTitle { margin: 0; }
    #modalBody { 
      margin-top: 16px; 
      flex-grow: 1; /* âœ… Fills remaining space */
      overflow-y: auto; /* âœ… Scrolls *only* the body */
      -webkit-overflow-scrolling: touch;
    }
    #modalBody pre {
       white-space: pre-wrap; 
       word-break: break-all; 
       margin: 0;
    }

    /* --- âœ… iPad Full-Screen Modal --- */
    @media (max-width: 1024px), (pointer: coarse) {
      body { padding: 8px; gap: 8px; }
      header h2 { font-size: 20px; }
      #top-controls { padding: 12px; }

      #modal .panel {
        max-width: none;
        width: 100vw;
        max-height: none;
        height: 100vh;
        border-radius: 0;
        box-shadow: none;
        padding: 16px;
        box-sizing: border-box;
      }
    }
    
  </style>
</head>
<body>
  <div id="loader-container"><div id="loader-bar"></div></div>



  <div id="top-controls">
    <div class="control-group">
      <label>Pairing PDF:
        <input type="file" id="pdfFileInput" accept=".pdf" class="btn">
      </label>
      <button id="uploadPdfBtn" class="btn btn-primary">Upload</button>
      <div id="uploadStatus"></div>
    </div>
    <div class="control-group">
      <label>Quick Search:
        <input id="quickSearch" type="text" placeholder="pairing, airport, flight#">
      </label>
    </div>
    <div class="control-group">
      <button id="filterSingleDay" class="btn">1-Day Trips Only</button>
      <button id="filterMultiDay" class="btn">Multi-Day Trips Only</button>
    </div>
    <div class="control-group">
      <button id="filterRedeye" class="btn">Redeyes Only</button>
      <button id="filterLazy" class="btn">Lazy Only</button>
      <button id="filterCommutable" class="btn">Commutable Only</button>
      <button id="filterWeekdays" class="btn">Weekdays Only</button>
      <button id="filterDeadhead" class="btn">Deadheads Only</button>
      <button id="filterAvoidDeadhead" class="btn">Avoid Deadheads</button>
    </div>
    <div class="control-group">
      <button id="downloadCsv" class="btn">Export CSV</button>
      <button id="downloadJson" class="btn">Export JSON</button>
      <button id="resetFilters" class="btn">Reset All Filters</button>
    </div>
    <div class="control-group push-right menu-wrap">
      <button id="toggleNight" class="btn">ðŸŒ™ Night Mode</button>
      <button id="columnMenuBtn" class="btn">Columns â–¾</button>
      <div id="columnMenu" class="dropdown" role="menu" aria-label="Column visibility">
        <h4>Show / Hide Columns</h4>
        <div class="hint">Drag headers to reorder. Sizes & visibility are saved.</div>
        <div id="columnMenuList"></div>
      </div>
    </div>
  </div>

  <div id="table-container">
    <div id="counts">Showing <strong id="countFiltered">0</strong> of <strong id="countTotal">0</strong> pairings</div>
    <div id="table"></div>
  </div>

  <div id="modal" class="modal">
    <div class="panel">
      <div id="modal-header">
        <h3 id="modalTitle"></h3>
        <button id="closeModal" class="btn">Close</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
  <script>
  // --- Element refs (Unchanged) ---
  const pdfFileInput = document.getElementById('pdfFileInput');
  const uploadPdfBtn = document.getElementById('uploadPdfBtn');
  const uploadStatusEl = document.getElementById('uploadStatus');
  const loaderContainer = document.getElementById('loader-container');
  const loaderBar = document.getElementById('loader-bar');

  // --- Loader functions (Unchanged) ---
  function showLoader(){ 
    loaderBar.style.transition = 'width .35s ease-out';
    loaderBar.style.width='0%';
    loaderContainer.style.display='block'; 
  }
  function updateUploadProgress(percent) {
    const barPercent = Math.min(percent * 0.9, 90);
    loaderBar.style.transition = 'width 0.1s linear';
    loaderBar.style.width = barPercent + '%';
  }
  function showParsingLoader() {
    uploadStatusEl.textContent = "Parsing PDF... This may take a moment.";
    loaderBar.style.transition = 'width 1.5s ease-out';
    loaderBar.style.width = '95%';
  }
  function hideLoader(){ 
    loaderBar.style.transition = 'width .35s ease-out';
    loaderBar.style.width='100%'; 
    setTimeout(()=>{ loaderContainer.style.display='none'; }, 350); 
  }

  // --- Data helpers (Unchanged) ---
  function minutes_to_clock(m){ if(m==null||isNaN(m)) return ""; const h=Math.floor(m/60), mm=m%60; return String(h).padStart(2,'0')+":"+String(mm).padStart(2,'0'); }
  function safeNum(v){ if(v===undefined||v===null||v==='') return null; return Number(v); }

  // --- normalize (Unchanged) ---
  function normalize(rawPairings){
    return rawPairings.map(x=>{ const c={...x}; 
      c.per_diem=safeNum(x.per_diem);
      c.correctedperdiem=safeNum(x.correctedperdiem);
      c.tafb_minutes=safeNum(x.tafb_minutes);
      c.credit_minutes=safeNum(x.credit_minutes);
      c.report_minutes=safeNum(x.report_minutes);
      c.release_minutes=safeNum(x.release_minutes);
      c.layovers=Array.isArray(x.layovers)?x.layovers:[];
      c.layover_locations_str=(c.layovers||[]).map(l=>l.location).join(', ');
      c.layovers_str=(c.layovers||[]).map(l=>{ const time=l.time||l.duration||l.length||''; return (time?`${l.location} [${time}]`:l.location).trim(); }).join('\n');
      c.days=x.days||{};
      const flatLegs=[]; Object.keys(c.days).forEach(dayKey=>{ const arr=c.days[dayKey]||[]; arr.forEach(item=>{ if(typeof item==='string') flatLegs.push(item); else if(item&&typeof item==='object'){ const parts=[]; if(item.flight_number) parts.push(item.flight_number); if(item.dep_station) parts.push(item.dep_station); if(item.arr_station) parts.push(item.arr_station); if(item.dep_time) parts.push(item.dep_time); if(item.arr_time) parts.push(item.arr_time); if(item.duration) parts.push(item.duration); if(parts.length===0) parts.push(JSON.stringify(item)); flatLegs.push(parts.join(' ')); } }); }); 
      c.flights_str=flatLegs.join('\n');
      c.duration_days=Object.keys(c.days||{}).length;
      c.days_of_work=x.days_of_work||c.duration_days||1;
      c.is_redeye=!!x.is_redeye;
      c.is_lazy_pairing=!!x.is_lazy_pairing;
      c.is_commutable=!!x.is_commutable;
      c.is_weekday_only=!!x.is_weekday_only;
      c.has_deadhead=!!x.has_deadhead;
      if(!c.pairing_number) c.pairing_number=c.trip_number||'(unknown)';
      return c; 
    });
  }

  // --- Filter logic (Unchanged) ---
  let table=null; 
  const initialFilterState={ tafb_filter:null, is_redeye:false, is_lazy_pairing:false, is_commutable:false, is_weekday_only:false, deadhead_filter:null, quickSearch:'' };
  let filterState={...initialFilterState};

  function applyTableFilters(){
    if(!table) return;
    const filters=[];
    if(filterState.tafb_filter==='long_only'){ filters.push({field:"days_of_work", type:">", value:1}); }
    else if(filterState.tafb_filter==='short_only'){ filters.push({field:"days_of_work", type:"=", value:1}); }
    if(filterState.is_redeye) filters.push({field:"is_redeye", type:"=", value:true});
    if(filterState.is_lazy_pairing) filters.push({field:"is_lazy_pairing", type:"=", value:true});
    if(filterState.is_commutable) filters.push({field:"is_commutable", type:"=", value:true});
    if(filterState.is_weekday_only) filters.push({field:"is_weekday_only", type:"=", value:true});
    if(filterState.deadhead_filter === 'only'){ filters.push({field:"has_deadhead", type:"=", value:true}); }
    else if(filterState.deadhead_filter === 'avoid'){ filters.push({field:"has_deadhead", type:"=", value:false}); }
    if(filterState.quickSearch){
      const q=filterState.quickSearch;
      filters.push([{field:"pairing_number", type:"like", value:q}, {field:"layovers_str", type:"like", value:q}, {field:"days", type:"like", value:q}, {field:"base", type:"like", value:q}, {field:"flights_str", type:"like", value:q}]);
    }
    table.setFilter(filters);
  }

  // --- Header filters (Unchanged) ---
  function timeHeaderEditor(cell,onRendered,success,cancel,params){ const input=document.createElement('input'); input.type='time'; input.style.width='95%'; input.addEventListener('change',()=>success(input.value)); return input; }
  function reportTimeFilter(headerValue,rowValue){ if(!headerValue) return true; if(rowValue==null) return false; const [h,m]=headerValue.split(':').map(Number); return rowValue>=(h*60+m); }
  function releaseTimeFilter(headerValue,rowValue){ if(!headerValue) return true; if(rowValue==null) return false; const [h,m]=headerValue.split(':').map(Number); return rowValue<=(h*60+m); }

  // --- UI updaters (Unchanged) ---
  function updateCounts(){
    if(!table) { document.getElementById('countFiltered').textContent='0'; document.getElementById('countTotal').textContent='0'; return; }
    const total = (table.getData()||[]).length;
    const filtered = table.getRows(true).length;
    document.getElementById('countFiltered').textContent = String(filtered);
    document.getElementById('countTotal').textContent = String(total);
  }

  function populateColumnMenu() {
    const menuList = document.getElementById('columnMenuList');
    menuList.innerHTML = '';
    if (!table) return;
    table.getColumns().forEach(column => {
      const def = column.getDefinition();
      if (!def.title) return;
      const row = document.createElement('div');
      row.className = 'row';
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      const fieldId = def.field || def.title.replace(/\s+/g, '-').toLowerCase();
      checkbox.id = `col-toggle-${fieldId}`;
      checkbox.checked = column.isVisible();
      checkbox.addEventListener('change', () => {
        if (checkbox.checked) column.show();
        else column.hide();
      });
      const label = document.createElement('label');
      label.textContent = def.title;
      label.setAttribute('for', checkbox.id);
      row.appendChild(checkbox);
      row.appendChild(label);
      menuList.appendChild(row);
    });
  }

  // --- âœ… createTable (MODIFIED with your requested changes) ---
  function createTable(data){
    if(table) table.destroy();
    resetFilters(false);
    table = new Tabulator("#table", {
      data: data,
      height: "100%", // âœ… Fills container
      headerHozAlign: "center",
      movableColumns: true,
      persistence: { columns: ["visible","width","frozen","title","order"], sort: true, filter: true },
      persistenceMode: "local",
      persistenceID: "pairings-multibase-v1",
      columns: [
        {title:"Pairing", field:"pairing_number", headerFilter:"input", width:90, hozAlign:"center", frozen:true},
        {title:"Dates", field:"operating_dates", headerFilter:"input", width:120, hozAlign:"center", formatter:cell=>{ const v=cell.getValue(); return Array.isArray(v)?`<pre style='margin:0;white-space:pre-wrap'>${v.join('\n')}</pre>`:(v||''); }},
        // --- âœ… Changes as requested ---
        {title:"Report", field:"report_minutes", hozAlign:"center", width:90, formatter:cell=>minutes_to_clock(cell.getValue()), headerFilter: timeHeaderEditor, headerFilterFunc: reportTimeFilter, headerFilterLiveFilter:true, headerFilterPlaceholder:"after"},
        {title:"Release", field:"release_minutes", hozAlign:"center", width:90, formatter:cell=>minutes_to_clock(cell.getValue()), headerFilter: timeHeaderEditor, headerFilterFunc: releaseTimeFilter, headerFilterLiveFilter:true, headerFilterPlaceholder:"before"},
        {title:"Details", hozAlign:"center", headerSort:false, width:70, formatter:()=>"<button class='btn'>Show</button>",
          cellClick:(e,cell)=> showModal(
            `Details â€” ${cell.getRow().getData().pairing_number}`, 
            cell.getRow().getData().original_text || "No original text found."
          )
        },
        {title:"Flights", field:"flights_str", headerFilter:"input", width:300, formatter:cell=>{ const v=cell.getValue()||''; return `<pre class='cell-left' style='margin:0;white-space:pre-wrap'>${v}</pre>`; }},
        {title:"Layovers", field:"layovers_str", headerFilter:"input", width:140, formatter:cell=>{ const v=cell.getValue()||''; return `<pre class'cell-left' style='margin:0;white-space:pre-wrap'>${v}</pre>`; }},
        {title:"Longest", field:"longest_layover", hozAlign:"center", width:90, sorter:"number", formatter:c=> c.getValue() ? parseFloat(c.getValue()).toFixed(2) : ""},
        // --- End Changes ---
        {title:"D", field:"days_of_work", hozAlign:"center", width:50, headerFilter:"list", headerFilterParams:{values:[1,2,3,4,5,6,7], multiselect:true}, headerFilterFunc:(hv,rv)=>!hv||hv.length===0||hv.includes(rv)},
        {title:"Credit", field:"credit_time", hozAlign:"center", width:80},
        {title:"C/D", field:"credit_time_per_day", hozAlign:"center", width:60},
      ],
      placeholder:"Upload a PDF to begin.",
      initialSort:[{column:"credit_time_per_day", dir:"desc"}],
      dataLoaded:updateCounts,
      dataFiltered:updateCounts,
    });
    updateCounts();
    populateColumnMenu();
  }
  // --- END createTable ---

  // Quick search listener (Unchanged)
  document.getElementById('quickSearch').addEventListener('input', e=>{ filterState.quickSearch=e.target.value; applyTableFilters(); });

  // --- âœ… showModal (MODIFIED for new layout) ---
  function showModal(title, data){
    document.getElementById('modalTitle').innerText=title;
    const modalBody = document.getElementById('modalBody');
    modalBody.innerHTML = ''; // Clear previous content
    const pre = document.createElement('pre');
    pre.className = 'cell-left'; 
    if (typeof data === 'string') pre.innerText = data;
    else if (typeof data === 'object' && data !== null) pre.innerText = JSON.stringify(data, null, 2);
    else pre.innerText = "No data available.";
    modalBody.appendChild(pre);
    document.getElementById('modal').style.display='flex';
  }
  document.getElementById('closeModal').addEventListener('click',()=> document.getElementById('modal').style.display='none');
  window.addEventListener('click', (ev)=>{ if(ev.target.id==='modal') document.getElementById('modal').style.display='none' });

  // --- Download/Reset buttons (Unchanged) ---
  document.getElementById('downloadCsv').addEventListener('click', ()=>{ if(!table) return alert('Load data first'); table.download('csv','pairings_export.csv'); });
  document.getElementById('downloadJson').addEventListener('click', ()=>{ if(!table) return alert('Load data first'); const blob=new Blob([JSON.stringify(table.getData(),null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='pairings_export.json'; a.click(); URL.revokeObjectURL(a.href); });

  function resetFilters(apply=true){
    document.getElementById('quickSearch').value='';
    filterState={...initialFilterState};
    ['filterSingleDay','filterMultiDay','filterRedeye','filterLazy','filterCommutable','filterWeekdays', 'filterDeadhead', 'filterAvoidDeadhead'].forEach(id=>{
      const btn = document.getElementById(id);
      if (btn) btn.classList.remove('btn-active');
    }); 
    if(table){
      table.clearHeaderFilter();
      if(apply) applyTableFilters(); else table.clearFilter();
      updateCounts();
    }
  }
  document.getElementById('resetFilters').addEventListener('click',()=> resetFilters());

  // --- Filter setup (Unchanged) ---
  function setupBooleanFilter(buttonId, stateKey) {
    const btn = document.getElementById(buttonId);
    if (!btn) return;
    btn.addEventListener('click', () => {
      const isActive = btn.classList.toggle('btn-active');
      filterState[stateKey] = isActive;
      applyTableFilters();
    });
  }

  // --- Night mode + column menu (Unchanged) ---
  const toggleNight=document.getElementById('toggleNight');
  toggleNight.addEventListener('click',()=>{
    const enabled=document.body.classList.toggle('dark');
    toggleNight.textContent=enabled?'â˜€ï¸ Light Mode':'ðŸŒ™ Night Mode';
    sessionStorage.setItem('pairingsNightMode', enabled?'1':'0');
  });
  if(sessionStorage.getItem('pairingsNightMode')==='1'){ document.body.classList.add('dark'); toggleNight.textContent='â˜€ï¸ Light Mode'; }

  const columnMenuBtn = document.getElementById('columnMenuBtn');
  const columnMenu = document.getElementById('columnMenu');
  columnMenuBtn.addEventListener('click', (e) => { e.stopPropagation(); columnMenu.classList.toggle('open'); if (columnMenu.classList.contains('open') && table) populateColumnMenu(); });
  document.addEventListener('click', (e) => { if (!columnMenu.contains(e.target) && e.target !== columnMenuBtn) columnMenu.classList.remove('open'); });

  // --- SHA-256 pre-hash & cache check (Unchanged) ---
  async function sha256File(file){
    const buf = await file.arrayBuffer();
    const digest = await crypto.subtle.digest("SHA-256", buf);
    return Array.from(new Uint8Array(digest)).map(b => b.toString(16).padStart(2,'0')).join('');
  }

  // --- XHR Upload logic (Unchanged) ---
  uploadPdfBtn.addEventListener('click', async () => {
    const file = pdfFileInput.files[0];
    if (!file) {
      uploadStatusEl.textContent = "Please select a PDF file first.";
      uploadStatusEl.style.color = "red";
      return;
    }
    showLoader();
    uploadPdfBtn.disabled = true;
    uploadStatusEl.textContent = "Hashing fileâ€¦";
    uploadStatusEl.style.color = "var(--muted-text)";
    let hash;
    try {
      hash = await sha256File(file);
    } catch (e) {
      console.error("Hash failed, falling back to upload:", e);
    }

    if (hash) {
      try {
        const r = await fetch('/api/check', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({hash})
        });
        const j = await r.json();
        if (j && j.exists) {
          uploadStatusEl.textContent = "Found in cache â€” loading instantlyâ€¦";
          const cached = await fetch(`/api/cache/${hash}`).then(x=>x.json());
          const normalizedData = normalize(cached.pairings || []);
          createTable(normalizedData);
          hideLoader();
          uploadPdfBtn.disabled = false;
          pdfFileInput.value = '';
          return;
        }
      } catch (e) {
        console.warn("Cache check failed, proceeding with upload:", e);
      }
    }

    uploadStatusEl.textContent = "Uploadingâ€¦";
    const formData = new FormData();
    formData.append('file', file);
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/api/upload', true);
    xhr.upload.onprogress = function(e) {
      if (e.lengthComputable) {
        const percentComplete = Math.round((e.loaded / e.total) * 100);
        updateUploadProgress(percentComplete);
        if (percentComplete < 100) uploadStatusEl.textContent = `Uploadingâ€¦ ${percentComplete}%`;
        else uploadStatusEl.textContent = "Upload complete. Processing schedule â€¦";
      }
    };
    xhr.onload = function() {
      showParsingLoader();
      try {
        if (xhr.status >= 200 && xhr.status < 300) {
          const parsedData = JSON.parse(xhr.responseText);
          if (!parsedData || !Array.isArray(parsedData.pairings)) {
            const errorMsg = (parsedData && parsedData.error) || "Invalid JSON response from server.";
            throw new Error(errorMsg);
          }
          const normalizedData = normalize(parsedData.pairings);
          createTable(normalizedData);
          uploadStatusEl.textContent = `Success! Found ${normalizedData.length} pairings.`;
          uploadStatusEl.style.color = "green";
        } else {
          let errorMsg = `Server responded with ${xhr.status}`;
          try { errorMsg = JSON.parse(xhr.responseText).error || errorMsg; } catch(_){}
          throw new Error(errorMsg);
        }
      } catch (error) {
        console.error("Upload failed:", error);
        uploadStatusEl.textContent = `Error: ${error.message}`;
        uploadStatusEl.style.color = "red";
        createTable([]);
      } finally {
        hideLoader();
        uploadPdfBtn.disabled = false;
        pdfFileInput.value = '';
      }
    };
    xhr.onerror = function() {
      console.error("Upload failed: Network error.");
      uploadStatusEl.textContent = "Error: Network failure. Please try again.";
      uploadStatusEl.style.color = "red";
      createTable([]);
      hideLoader();
      uploadPdfBtn.disabled = false;
      pdfFileInput.value = '';
    };
    xhr.send(formData);
  });

  // --- Filter Button Listeners (Unchanged) ---
  setupBooleanFilter('filterRedeye', 'is_redeye');
  setupBooleanFilter('filterLazy', 'is_lazy_pairing');
  setupBooleanFilter('filterCommutable', 'is_commutable');
  setupBooleanFilter('filterWeekdays', 'is_weekday_only');

  const btnSingle = document.getElementById('filterSingleDay');
  const btnMulti = document.getElementById('filterMultiDay');
  if (btnSingle && btnMulti) {
    btnSingle.addEventListener('click', () => {
      const wasActive = btnSingle.classList.contains('btn-active');
      btnMulti.classList.remove('btn-active');
      btnSingle.classList.toggle('btn-active');
      filterState.tafb_filter = !wasActive ? 'short_only' : null; 
      applyTableFilters();
    });
    btnMulti.addEventListener('click', () => {
      const wasActive = btnMulti.classList.contains('btn-active');
      btnSingle.classList.remove('btn-active');
      btnMulti.classList.toggle('btn-active');
      filterState.tafb_filter = !wasActive ? 'long_only' : null; 
      applyTableFilters();
    });
  }

  const btnDeadheadOnly = document.getElementById('filterDeadhead');
  const btnAvoidDeadhead = document.getElementById('filterAvoidDeadhead');
  if (btnDeadheadOnly && btnAvoidDeadhead) {
    btnDeadheadOnly.addEventListener('click', () => {
      const wasActive = btnDeadheadOnly.classList.contains('btn-active');
      btnAvoidDeadhead.classList.remove('btn-active'); 
      btnDeadheadOnly.classList.toggle('btn-active'); 
      filterState.deadhead_filter = !wasActive ? 'only' : null;
      applyTableFilters();
    });
    btnAvoidDeadhead.addEventListener('click', () => {
      const wasActive = btnAvoidDeadhead.classList.contains('btn-active');
      btnDeadheadOnly.classList.remove('btn-active'); 
      btnAvoidDeadhead.classList.toggle('btn-active'); 
      filterState.deadhead_filter = !wasActive ? 'avoid' : null; 
      applyTableFilters();
    });
  }

  // --- Initialize Table ---
  createTable([]); // Initialize empty table
  </script>
</body>
</html>